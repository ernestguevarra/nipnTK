---
title: "Age and sex distributions"
author: "Mark Myatt"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(nipnTK)
library(bbw)
library(knitr)
library(kableExtra)
```

## Age and sex distributions (children's data)
Age heaping is the tendency to report children's ages to the nearest year or adult ages to the nearest multiple of 5 or 10 years. Age heaping is very common. It is a major reason why data from nutritional anthropometry surveys are often analysed and reported using broad age-groups. The commonest age- groups used with childrenâ€™s data are 6 to 17 months, 18 to 29 months, 30 to 41 months, 42 to 53 months, and 54 to 59 months (see figure below). These are known as year-centred age-groups. Note that the last age-group covers only six months but is nominally centred at five years. Other age-groups may be used for specific analyses. The techniques presented here can be adapted to work with other age- groups.

```{r pyramidPlot, echo = FALSE, eval = TRUE, fig.align = "center"}
include_graphics(path = "../man/figures/pyramidPlot.png")
```

We will retrieve a survey dataset:

```{r as1, echo = TRUE, eval = FALSE}
svy <- read.table("dp.ex02.csv", header = TRUE, sep = ",") 
head(svy)
```

```{r as1a, echo = FALSE, eval = TRUE}
svy <- dp.ex02 
head(svy)
```

The dataset `dp.ex02` is a comma-separated-value (CSV) file containing anthropometric data from a SMART survey in Kabul, Afghanistan.

### Tabulation and visualisation

The NiPN data quality toolkit provides an R language function called `recode()` that makes it easy to recode and group data. We will use the `recode()` function to group the data in the age variable (age in months) into year-centred age-groups.

```{r as2, echo = TRUE, eval = TRUE}
svy$ycag <- recode(svy$age, "6:17=1; 18:29=2; 30:41=3; 42:53=4; 54:59=5")
head(svy)
```

A tabular analysis can be performed:

```{r as3, echo = TRUE, eval = TRUE}
table(svy$ycag, svy$sex) 
prop.table(table(svy$ycag, svy$sex)) * 100
```

The `table()` function performs a cross-tabulation. The first variable specified (`svy$ycag` in this example) is the row variable. The second variable specified (`svy$sex` in this example) is the column variable.

```{r asTable, echo = FALSE, eval = TRUE, fig.align = "center"}
include_graphics(path = "../man/figures/asTable.png")
```

It is useful to examine row percentages and column percentages in tables of age-group by sex. We should look at row percentages:

```{r as4, echo = TRUE, eval = FALSE}
prop.table(table(svy$ycag, svy$sex), margin = 1) * 100
```

This returns:

```{r as4a, echo = FALSE, eval = TRUE}
prop.table(table(svy$ycag, svy$sex), margin = 1) * 100
```

Which shows approximately equal proportions of males and females in each year-centred age-group. We specified `margin = 1` with the `prop.table()` function because we wanted row percentages.

We should also look at column percentages:

```{r as5, echo = TRUE, eval = FALSE}
prop.table(table(svy$ycag, svy$sex), margin = 2) * 100 
```

This returns:

```{r as5a, echo = FALSE, eval = TRUE}
prop.table(table(svy$ycag, svy$sex), margin = 2) * 100 
```

We expect there to be approximately equal proportions of children in the age-groups centred at 1, 2, 3, and 4 years and a smaller proportion (i.e. about half that in the other age-groups) in the age-group centred at 5 years. We specified `margin = 2` with the `prop.table()` function because we wanted column percentages.

A graphical analysis using a population pyramid can be useful. The NiPN data quality toolkit provides an *R* language function called `pyramid.plot()` for plotting population pyramids:

```{r as6, echo = TRUE, eval = TRUE, fig.align = "center"}
pyramid.plot(svy$ycag, svy$sex)
```

We can make a more informative plot by specifying a title and axis labels:

```{r as6a, echo = TRUE, eval = TRUE, fig.align = "center"}
pyramid.plot(svy$ycag, svy$sex, 
             main = "Distribution of age by sex",
             xlab = "Frequency (Males | Females)", 
             ylab = "Year-centred age-group")
```

and applying shading:

```{r as6b, echo = TRUE, eval = TRUE, fig.align = "center"}
pyramid.plot(svy$ycag, svy$sex, 
             main = "Distribution of age by sex",
             xlab = "Frequency (Males | Females)", 
             ylab = "Year-centred age-group",
             col = c("grey80", "white"))
```

or colours:

```{r as6c, echo = TRUE, eval = TRUE, fig.align = "center"}
pyramid.plot(svy$ycag, svy$sex, 
             main = "Distribution of age by sex",
             xlab = "Frequency (Males | Females)", 
             ylab = "Year-centred age-group",
             col = c("lightblue", "pink"))
```

We expect there to be approximately equal numbers of children in the age-groups centred at 1, 2, 3, and 4 years and a smaller number (i.e. about half the number in the other age-groups) in the age-group centred at 5 years. There should also be approximately equal numbers of males and females. This is what we see in the population pyramid below.

```{r pyramid, echo = FALSE, eval = TRUE, fig.align = "center", fig.height = 8, fig.width = 6}
tza <- as.ex01
tza$ycage <- cut(x = tza$age, 
                 breaks = seq(from = 0, to = 100, by = 5),
                 include.lowest = TRUE)

pyramid.plot(x = tza$ycage,
             g = tza$sex,
             main = "Age-group by sex",
             xlab = "Number (Males | Females)",
             ylab = "",
             las = 1)
```


The `pyramid.plot()` function uses the values of the grouped age variable as y-axis value labels. 

We can assign descriptive text values using the `recode()` function. For example:

```{r as7, echo = TRUE, eval = TRUE, fig.align = "center"}
svy$ageLabel <- recode(svy$age, "6:29='< 30 months'; 30:hi='30 month or older'")

pyramid.plot(svy$ageLabel, 
             svy$sex, 
             main = "Distribution of age by sex", 
             xlab = "Frequency (Males | Females)", 
             ylab = "Age-group")
```

We can also use a factor type variable. This type of variable allows labels to be specified: 

```{r as7a, echo = TRUE, eval = TRUE, fig.align = "center"}
svy$ageLabel <- factor(svy$ycag,
                       labels = c("6:17", "18:29", "30:41", "42:53", "54:59"))

pyramid.plot(svy$ageLabel, 
             svy$sex, 
             main = "Distribution of age by sex", 
             xlab = "Frequency (Males | Females)", 
             ylab = "Year-centred age-group")
```

The `cut()` function may also be used:

```{r as7b, echo = TRUE, eval = TRUE, fig.align = "center"}
svy$ageCuts <- cut(svy$age, breaks = c(0, 17, 29, 41, 53, 59))

pyramid.plot(svy$ageCuts, 
             svy$sex, 
             main = "Age-group (months) ",
             xlab = "Frequency (Males | Females)", 
             ylab = "Year-centred age-group",
             cex.names = 0.9)
```

The `cut()` function is a versatile grouping function. It is explained in more detail later in this section.

The `cex.names` parameter of the `pyramid.plot()` function allows us to change the size of the value labels on the `y-axis`. The value for cex.names is a magnification factor. Values above one make the labels larger than the default. Values below one make the labels smaller than the default.

## Simple testing

It is possible to perform a formal test on the distribution of age-groups by sex. A simple test is:

```{r as8, echo = TRUE, eval = FALSE}
chisq.test(table(svy$ycag, svy$sex))
```

This yields:

```{r as8a, echo = FALSE, eval = TRUE}
chisq.test(table(svy$ycag, svy$sex))
```

In this example the p-value is not below 0.05 so we accept the null hypothesis that there is no significant association between age and sex. This is an important test as it tests whether the distribution of ages is similar for males and females. It does not, however, test whether the age structure in the sample meets expectations. This requires a test that compares observed numbers with expected numbers derived from an external source (e.g. census data) or from a demographic model.

### A model of the expected age structure

A simple model-based method for calculating expected numbers is exponential decay in a population in which births and deaths balance each other and with a 1:1 male to female sex ratio. Under this model the proportion surviving in each group at each year can be calculated as:

$$ p ~ = ~ e ^ {-zt} $$

in which e is the base of the natural logarithm (approximately 2.7183), z is the mortality rate associated with each time period, and t is time. Time (t) starts at zero for the purposes of computation. Age can be used as a measure of time since birth. We should use 0 for the first year-centred age-group, 1 for the second year-centred age-group, and so-on. This is the rationale for us using `t <- 0:4` below.

With five year-centred age-groups and a mortality rate of 1 / 10,000 / day, the expected proportions surviving at each year can be calculated as:

```{r as9, echo = TRUE, eval = FALSE}
z <- (1 / 10000) * 365.25 

t <- 0:4

p <- exp(-z * t)

p
```

This yields the following survival probabilities:

```{r as9a, echo = TRUE, eval = TRUE}
z <- (1 / 10000) * 365.25 

t <- 0:4

p <- exp(-z * t)

p
```

We need to specify the duration (i.e. the number of years) represented by each age-group:

```{r as9b, echo = TRUE, eval = TRUE}
d <- c(1, 1, 1, 1, 0.5)
```

We can then calculate expected proportions of children in each age-group:

```{r as9c, echo = TRUE, eval = FALSE}
ep <- d * p / sum(d * p) 

ep
```

This gives:

```{r as9d, echo = FALSE, eval = TRUE}
ep <- d * p / sum(d * p) 

ep
```

We can now calculate expected numbers:

```{r as9e, echo = TRUE, eval = FALSE}
expected <- ep * sum(table(svy$ycag)) names(expected) <- 1:5

expected
```

giving:

```{r as9f, echo = FALSE, eval = TRUE}
expected <- ep * sum(table(svy$ycag)) 

names(expected) <- 1:5

expected
```

A formal test would compare the observed numbers with the expected numbers. The observed numbers can be found using:

```{r as9g, echo = TRUE, eval = FALSE}
observed <- table(svy$ycag) 

observed
```

This gives:

```{r as9h, echo = FALSE, eval = TRUE}
observed <- table(svy$ycag) 

observed
```

It can be useful to examine observed and expected numbers graphically:

```{r as9i, echo = TRUE, eval = TRUE, fig.align = "center"}
par(mfcol = c(1, 2))
barplot(observed, main = "Observed", xlab = "Age group", ylab = "Frequency", ylim = c(0, 250))
barplot(expected, main = "Expected", xlab = "Age group", ylab = "Frequency", ylim = c(0, 250))
```

We will calculate a Chi-squared test statistic:


$$ \chi ^ 2 ~ = ~ \sum \frac{(\text{observed} - \text{expected}) ^ 2}{\text{expected}} $$

using:

```{r as9j, echo = TRUE, eval = FALSE}
X2 <- sum((observed - expected) ^ 2 / expected)
```

which yields a Chi-Squared test statistic of:

```{r as9k, echo = FALSE, eval = TRUE}
X2 <- sum((observed - expected) ^ 2 / expected)
```

We can find the p-value using:

```{r as9l, echo = TRUE, eval = FALSE}
pchisq(X2, df = 4, lower.tail = FALSE)
```

This gives:

```{r as9m, echo = FALSE, eval = TRUE}
pchisq(X2, df = 4, lower.tail = FALSE)
```

In this example the age distribution is significantly different from expected numbers calculated using a simple demographic model.

Note that we specify the degrees of freedom (`df`) for the Chi-Squared test as the number of age-groups minus one. As we have five age-groups we specify `df = 4`. The degrees of freedom (`df`) that we need to specify will depend on the number of age-groups that we use. It is always the number of age-groups minus one. If, for example, there are ten age-groups we would need to specify `df = 9`.

The NiPN data quality toolkit provides an R function called `ageChildren()` that performs the model- based Chi-Squared test:

```{r as10, echo = TRUE, eval = FALSE}
ageChildren(svy$age, u5mr = 1)
```

which returns:

```{r as10a, echo = FALSE, eval = TRUE}
ageChildren(svy$age, u5mr = 1)
```

Note that we specified the under five years mortality rate as 1 / 10,000 / day using `u5mr = 1`. Another, more appropriate, rate may be specified.

The `ageChildren()` function calculates year-centred age-groups for children aged between six and fifty-nine months by default. This is a standard survey population and is used in SMART and many other surveys. The use of year-centred age-groups is also standard practice. The commands that are given above can, however, be adapted for use with different age-groups.

The output of the `ageChildren()` function can be saved for later use: 

```{r as10b, echo = TRUE, eval = TRUE}
ac <- ageChildren(svy$age, u5mr = 1)
```

The saved output contains the Chi-squared test results and tables of observed and expected values. These can be accessed using:

```{r as10c, echo = TRUE, eval = TRUE}
ac

ac$X2

ac$df

ac$p 

ac$observed 

ac$expected
```

The saved results may also be plotted:

```{r as10d, echo = TRUE, eval = TRUE, fig.align = "center"}
plot(ac)
```

The `ageChildren()` function can be applied to each sex separately. To males:

```{r as11, echo = TRUE, eval = TRUE, fig.align = "center"}
acM <- ageChildren(svy$age[svy$sex == 1], u5mr = 1) 

acM

plot(acM)
```

and to females:

```{r as12, echo = TRUE, eval = TRUE, fig.align = "center"}
acF <- ageChildren(svy$age[svy$sex == 2], u5mr = 1) 

acF

plot(acF)
```

An easier way of doing this is:

```{r as13, echo = TRUE, eval = TRUE}
by(svy$age, svy$sex, ageChildren, u5mr = 1)
```

The test statistics should be interpreted with caution. A significant test result may, for example, be due to the use of an inappropriate model to generate expected numbers.

A significant result in this particular test may be due to:

* **Specifying an inappropriate under five years mortality rate:** This is a particular problem because the specified under five years mortality rate is assumed to have applied for five years prior to data being collected.

* **The assumption of a 1:1 male to female sex ratio:** This is a particular problem in setting in which there is sex-selective abortion and sex-selective infanticide.

The model is crude. Mortality is related to age. Younger children have a greater mortality risk than older children and only an average under five years mortality rate is used. A more sophisticated model could be used but, in many settings, we will not have the data required to use such a model.

It should also be noted that the sample sizes used in most survey can cause tests to yield statistically significant results for small differences between observed and expected numbers.
